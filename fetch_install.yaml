---
- name: Fetch {{ name | default(tag) }}
  tags:
    - fetch
    - "{{ tag }}"
  git:
    repo: "{{ repo }}"
    dest: "{{ dest }}"
    version: "{{ ref | default('master') }}"
  register: fetch

- name: Create Build-dir for {{ name | default(tag) }}
  tags:
    - build-dir
    - "{{ tag }}"
  file:
    path: "{{ build_dir }}"
    state: directory
  when: build_dir is defined

- name: Update {{ name | default(tag) }}
  tags:
    - update
    - "{{ tag }}"
  command: "{{ item }}"
  with_items: "{{ commands }}"
  args:
    chdir: "{{ build_dir | default(dest) }}"
    creates: "{{ creates | default(omit) }}"
  when: fetch.changed and commands is defined

- name: Create install dir {{ name | default(tag) }}
  tags:
    - install
    - "{{ tag }}"
  file:
    path: "{{ install.dest }}/"
    state: directory
    mode: 0755
  when: install is defined

- name: Install {{ name | default(tag) }}
  tags:
    - install
    - "{{ tag }}"
  copy:
    src: "{{ item }}"
    dest: "{{ install.dest }}/{{ item | basename }}"
    owner: "{{ install.owner | default(omit) }}"
    mode: "{{ install.mode | default(0644) }}"
  with_fileglob: "{{ dest }}/{{ install.src }}"
  when: install is defined
