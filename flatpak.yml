---
- name: "Flatpak: Fetch key for {{ remote }}"
  get_url:
    url: "{{ key }}"
    dest: "{{ ansible_user_dir }}/Downloads/flatpak-remote-{{ remote }}.gpg"
    mode: 0400
  when: key is defined

- command: "flatpak remote-list --user"
  register: flatpak_remotes
- command:  echo "{{ flatpak_remotes.stdout | regex_replace(' *','') }}"
  register: flatpak_remotes

- name: "Flatpak: Add {{ remote }} remote"
  command: >
    flatpak remote-add
    --user
    {{ (key is defined)
       | ternary('--gpg-import=%s/Downloads/flatpak-remote-%s.gpg',
                 '--no-gpg-verify%s%s')
       | format((key is defined) | ternary(ansible_user_dir, ''),
                (key is defined) | ternary(remote,           ''))
    }}
    {{ remote }}
    {{ repo }}
  when: remote not in flatpak_remotes.stdout_lines

- name: "Flatpak: Install runtimes"
  command: >
    flatpak install
    --user
    {{ remote }}
    {{ item.name }}
    {{ version }}
  args:
    creates: "{{ install_prefix }}/share/flatpak/runtime/{{ item.name }}/x86_64/{{ version }}/"
  with_items: "{{ runtimes }}"

- name: "Flatpak: Install apps"
  command: >
    flatpak install
    --user
    {{ remote }}
    {{ item.name }}
    {{ version }}
  args:
    creates: "{{ install_prefix }}/share/flatpak/app/{{ item.name }}/x86_64/{{ version }}/"
  with_items: "{{ apps }}"
